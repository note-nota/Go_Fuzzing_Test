# Go_Fuzzing_Test

[Tutorial: Getting started with fuzzing](https://go.dev/doc/tutorial/fuzz)

## イントロダクション

このチュートリアルでは、Goでのファジングの基本を紹介します。ファジングを使用すると、脆弱性やクラッシュの原因となる入力を見つけようとして、テストに対してランダムデータが実行されます。ファジングによって発見される可能性のある脆弱性の例としては、SQLインジェクション、バッファオーバーフロー、サービス拒否、クロスサイトスクリプティング攻撃などがあります。

このチュートリアルでは、単純な関数のファジングテストを記述し、goコマンドを実行して、コードの問題をデバッグおよび修正します。

### “ファジング” とは？

> ファジング（英語: fuzzing）とは、コンピュータプログラムヘの入力として、無効なデータ、予期しないデータ、ランダムなデータを用いた自動化ないし半自動化されたソフトウェアテストの手法である。コンピュータプログラムにファズ（「予測不可能な入力データ」の意、英語: fuzz）を与えることで、意図的に例外的な状況を発生させ、その例外的な状況での挙動を確認するという方法を用いる。ファズテスト（fuzz testing）とも呼ばれる。また、ファジングの対象プログラムに対してファズテストを実行するツールは、ファザー（fuzzer）と呼ばれる。

[[wikipedia]ファジング](https://ja.wikipedia.org/wiki/%E3%83%95%E3%82%A1%E3%82%B8%E3%83%B3%E3%82%B0) より

## テスト対象の作成

文字列を逆にする関数 (`Reverse`) を対象にする。

> Note: This code is based on the `stringutil.Reverse` function within `golang.org/x/example`.

```shell
go run .
```

## 単体テストの追加

ここでのテストは、リストされた入力文字列が正しく反転されることを明らかにします。

```shell
go test -run=TestReverse
```

## ファジングテストの追加

単体テストには制限があります。つまり、開発者が各入力をテストに追加する必要があります。ファジングの利点の1つは、コードの入力が生成され、思いついたテストケースが到達しなかったエッジケースを識別できることです。

単体テスト、ベンチマーク、およびファジングテストは同じ `* _test.go` ファイルに保持できます。ただし、ここでは、単体テストをファジングテストに変換します。

ファジングにもいくつかの制限があります。単体テストでは、`Reverse` 関数の期待される出力を予測し、実際の出力がそれらの期待を満たしていることを確認できます。が、ファジングする場合、入力を制御できないため、期待される出力を予測することはできません。

### 単体テストとファズテストの構文の違い

- 関数は`TestXxx`ではなく`FuzzXxx`で始まり、`*testing.T` の代わりに `*testing.F` を用います。
- `t.Run` の代わりに `f.Fuzz` でテストを実行し、`*testing.T` を引数にもつファズターゲット関数とファズ化されるタイプを受け取ります。
- 単体テストからの入力は、`f.Add` を用いてシードコーパス入力として提供されます。

### 単体テスト
```shell
go test -run=FuzzReverse
```

### ファズテスト
```shell
go test -run=FuzzRevers -fuzz=Fuzz
```

ファジング中に障害が発生し、問題の原因となった入力が、シードコーパスファイルに書き込まれ、`-fuzz` フラグがなくても次回 `go test` 実行時に実行されるます。失敗の原因となった入力は、`testdata/fuzz/FuzzReverse` ディレクトリにコーパスファイルとして書き込まれます。シードコーパスファイルには異なる文字列が含まれている場合がありますが、形式は同じです。

## エラーの修正①

```main.go/Reverse
byte -> rune
```

この修正で単体テストが通るようになりますが、再度ファズテストを行うとエラーケースが発見されます。

## エラーの修正②

デバッグログなどにより、入力値・反転値・再反転値を確認すれば、入力が無効な Unicode であることが確認されます。

Reverse 関数に対して、入力文字列に有効なUTF-8ではない文字が含まれている場合エラーを返す、ようなガード節を追加します。合わせて、関数の返り値にエラーが含まれるので、呼び出し側も修正します。

### Tips

#### a. 特定コーパスによる単体テスト

```shell
go test -run={FuzzTestName}/{filename}
```

ファズテストで得られたエラー入力だけをテストしたいときには、`filename` を指定して単体テストを行うことができます。

#### b. ファズテストのタイムアウト

```shell
go test -fuzz=Fuzz -fuzztime 30s
```

デフォルトではファズテストは障害が発見されるまで実行されます。`-fuzztime` フラグを指定すると、指定の期間（上記例では 30 秒）障害が見つからなかった場合にテストが停止します。


## 参考

- [[Go Doc] Go Fuzzing](https://go.dev/doc/fuzz/)

